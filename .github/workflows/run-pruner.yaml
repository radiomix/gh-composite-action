# This workflow prunes old workflow runs for an entire repository.
# Source: https://github.community/t/delete-old-workflow-results/16152/41
# Source: https://github.community/t/delete-old-workflow-results/16152/42
#

name: Workflow Run Pruner

on:
  workflow_dispatch:

jobs:
 prune_old_runs:
    runs-on: ubuntu-latest
    steps:
      # Check out code using git
      - uses: actions/checkout@v2

      - name: âœ‚ Remove runs of the cleanup workflow itself
        # https://github.community/t/delete-old-workflow-results/16152/44
        uses: actions/github-script@v5
        # https://github.com/actions/github-script
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          debug: true
          script: |
            // https://github.com/actions/github-script#welcome-a-first-time-contributor
            const creator = context.payload.sender.login

            const pages = 5;

            let runs_to_delete = [];

            for (let page = 0; page < pages; page += 1) {
              let response = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                page: page,
                per_page: 100,
                repo: context.repo.repo,
                workflow_id: 'workflow_run_pruner.yml'
              });

              if (response.data.workflow_runs.length > 0) {
                for (const run of response.data.workflow_runs) {
                    runs_to_delete.push([run.id, run.name]);
                }
              }
            }

            for (const run of runs_to_delete) {
              console.log(`[Deleting] Run id ${run[0]} of '${run[1]}'.`);
              try {
                await github.rest.actions.deleteWorkflowRun({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  run_id: run[0]
                });
              } catch (error) {
                // ignore errors
              }
            }

##############################################################
      # Install Node 12
      # - uses: actions/setup-node@v1
      #   with:
      #     version: 12
      # - run: npm install @octokit/action
      # # Node.js script can be anywhere. A good convention is to put local GitHub Actions
      # # into the `.github/actions` folder
      # - run: node .github/actions/prune_cancelled_skipped_runs.js
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # runs-on: ubuntu-latest
    # timeout-minutes: 10

    # steps:
    # - name: Checkout code
    #   uses: actions/checkout@v2

    # - name: Setup nodes and install octokit/action
    #   # Install Node 12
    #   uses: actions/setup-node@v1
    #     with:
    #       version: 12
    #   - run: npm install @octokit/action

    # - name: Prune cancelled/skipped runs
    #   run: node .github/actions/prune_cancelled_skipped_runs.js
    #     env:
    #       GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # - name: Prune runs older than 30 days
    #   run: node .github/actions/prune_old_runs.js
    #     env:
    #       GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
