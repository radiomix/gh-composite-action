##

name: Conditional Step

on:
  workflow_dispatch:
  pull_request:
    types:
      - closed

jobs:
  step-on-condition:
    runs-on: ubuntu-latest
    permissions:
      # Explicit permissions needed for peter-evans/create-pull-request
      pull-requests: write
      contents: write
    env:
      releasePrefix: 'release'
      releaseVersion: '1.2.3'
      developmentVersion: '1.2.4-SNAPSHOT'
      baseBranch: 'main'

    steps:
      - uses: haya14busa/action-cond@v1
        id: releaseCondition
        with:
          cond: ${{ github.event.pull_request.merged == true }}
          if_true: 'perform'
          if_false: 'prepare'
      - name: Show release action
        run: |
          echo "** RUNNING: mvn release:${{ steps.releaseCondition.outputs.value }}"
        shell: bash

      - uses: actions/checkout@v3

      # Prepare git and ensure peter-evans/create-pull-request creates a new PR
      - name: Prepare PR ${{ env.releasePrefix }}-${{ env.releaseVersion }}
        run: |
          git config --global user.email "GithubAction@support.eyefreight.com"
          git config --global user.name "Github Actions"
          echo "****** git config -l --global *******"
          git config -l --global
          echo "" >> releases.txt
          echo "New ${{ env.releasePrefix }}-${{ env.releaseVersion }} with:" >> releases.txt
          echo "Phase: ${{ steps.releaseCondition.outputs.value }}" >> releases.txt
          git add releases.txt
        shell: bash

      - name: Create PR ${{ env.releasePrefix }}-${{ env.releaseVersion }}
        # See https://github.com/peter-evans/create-pull-request
        if: github.event.pull_request.merged == false
        uses: peter-evans/create-pull-request@v4
        id: create-release-pr
        with:
          # Branch name for of the PR to create
          branch: "${{ env.releasePrefix }}-${{ env.releaseVersion }}"
          title: "${{ env.releasePrefix }}-${{ env.releaseVersion }}"
          commit-message: Create PR ${{ env.releasePrefix }}-${{ env.releaseVersion }}
          reviewers: radiomix
          body: |
            ## Release `${{ env.releasePrefix }}-${{ env.releaseVersion }}`
            - Release version: `${{ env.releaseVersion }}`
            - Development version: `${{ env.developmentVersion }}`
            -------------

            - [ ] Change log has been added
            - [ ] New feature are described
            - [ ] Breaking change are described
            - [ ] Documentation has been update

            -------------

            - [ ] previous/related PR:
            - [ ] Jira Card:
            - [ ] Teams Channel:
            - [ ] Slack Channel:
          labels: ${{ env.releasePrefix }}


      ###################################################
      # Now in branch ${{ env.releasePrefix }}-${{ env.releaseVersion }} #
      ###################################################

      - name: Maven Release:Prepare ${{ env.releasePrefix }}-${{ env.releaseVersion }}
        if: github.event.pull_request.merged == false
        run: |
          if [[ ${{ steps.releaseCondition.outputs.value }} == prepare ]]
          then
            echo -e " *** Prepare release ${{ env.releasePrefix }}-${{ env.releaseVersion }} with:
            mvn -B release:clean release:prepare"
          else
            echo "*** Phase: ${{ steps.releaseCondition.outputs.value }}"
          fi
        shell: bash

      - name: Maven Release:Perform ${{ env.releasePrefix }}-${{ env.releaseVersion }}
        if: github.event.pull_request.merged == true
        run: |
          if [[ ${{ steps.releaseCondition.outputs.value }} == perform ]]
          then
            echo -e " *** Perform release ${{ env.releasePrefix }}-${{ env.releaseVersion }} with:
            mvn -B release:perform"
          else
            echo "*** Phase: ${{ steps.releaseCondition.outputs.value }}"
          fi
        shell: bash

      - name: Show PR ${{ env.releasePrefix }}-${{ env.releaseVersion }} for ${{ steps.releaseCondition.outputs.value }}
        if: github.event.pull_request.merged == true
        run: |
          git branch
          echo "Phase: ${{ steps.releaseCondition.outputs.value }}" >> releases.txt
          echo " - Target Branch            - ${{ env.releasePrefix }}-${{ env.releaseVersion }}"  >> releases.txt
          echo " - Release Version          - ${{ env.releaseVersion }}"  >> releases.txt
          echo " - Development Version      - ${{ env.developmentVersion }}"  >> releases.txt
          echo " - Pull Request URL         - ${{ steps.create-release-pr.outputs.pull-request-url }}" >> releases.txt
          echo " - Pull Request operation   - ${{ steps.create-release-pr.outputs.pull-request-operation }}" >> releases.txt
          echo " - Pull Request Commit SHA  - ${{ steps.create-release-pr.outputs.pull-request-head-sha }}" >> releases.txt
          echo " - Time                     - $(date -u )" >> releases.txt
          git add releases.txt
          git commit -m "Update release.txt for PR ${{ env.releasePrefix }}-${{ env.releaseVersion }} Phase: ${{ steps.releaseCondition.outputs.value }}"
          git push -v -u origin ${{ env.baseBranch }}
        shell: bash
